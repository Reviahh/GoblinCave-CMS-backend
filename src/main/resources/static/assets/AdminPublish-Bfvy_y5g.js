import{_ as U,r as f,d as Y,e as q,l as r,f as l,w as a,g as i,u as D,q as C,i as b,t as E,E as d,s as y}from"./index-LBqe1eNs.js";import{u as R,a as z}from"./api-BhPjLLsq.js";import{b as I}from"./style-D2LCvmlZ.js";const N={class:"publish-page"},P={class:"form-section"},B={class:"form-section"},A={class:"editor-container"},L={class:"form-actions"},S="light",F="github",O="github",j={__name:"AdminPublish",setup(G){const p=f(null),h=D(),e=f({title:"",content:"",summary:"",startTime:"",deadline:"",maxMembers:3}),c=f(!1),w=["bold","underline","italic","strikeThrough","-","title","sub","sup","quote","-","unorderedList","orderedList","task","-","codeRow","code","-","link","image","table","-","revoke","next","=","preview","fullscreen"],V=async(m,t)=>{const u=await Promise.all(m.map(async s=>{try{const n=await R(s);return n&&n.code===0&&n.data?n.data:(d.error(n?.message||"图片上传失败"),"")}catch{return d.error("图片上传失败"),""}}));t(u.filter(s=>s))},x=async()=>{if(p.value)try{if(!await p.value.validate()){d.error("请检查表单，填写完整信息");return}if(!e.value.content&&!e.value.summary){d.warning("竞赛内容或简介不能为空，至少填写其一");return}if(!e.value.deadline){d.warning("请选择截止日期");return}if(!e.value.maxMembers||e.value.maxMembers<1){d.warning("人数限制必须大于等于 1");return}c.value=!0;const t={name:e.value.title,summary:e.value.summary||(e.value.content?e.value.content.substring(0,200):""),content:e.value.content||"",startTime:e.value.startTime?e.value.startTime+"T00:00:00":null,endTime:e.value.deadline?e.value.deadline+"T23:59:59":null,maxMembers:e.value.maxMembers,organizer:"系统管理员",coverUrl:""},u=await z(t);if(u&&u.code===0)y({title:"发布成功",message:"竞赛已成功发布！",type:"success",duration:3e3}),g(),setTimeout(()=>{h.push("/competitions")},500);else throw new Error(u?.message||"发布失败")}catch(m){console.error("发布失败:",m);const t=m?.message||"发布过程中发生错误";y({title:"发布失败",message:t,type:"error",duration:5e3})}finally{c.value=!1}},g=()=>{p.value&&p.value.resetFields(),e.value={title:"",content:"",summary:"",startTime:"",deadline:"",maxMembers:3}};return(m,t)=>{const u=i("el-input"),s=i("el-form-item"),n=i("el-date-picker"),v=i("el-col"),M=i("el-input-number"),T=i("el-row"),_=i("el-button"),k=i("el-form");return q(),Y("div",N,[t[10]||(t[10]=r("div",{class:"page-header"},[r("h2",null,"发布试炼"),r("p",{class:"subtitle"},"使用 Markdown 编写试炼内容")],-1)),l(k,{model:e.value,"label-position":"top",ref_key:"formRef",ref:p,class:"publish-form"},{default:a(()=>[r("div",P,[t[6]||(t[6]=r("h3",{class:"section-title"},"基本信息",-1)),l(s,{label:"试炼标题",prop:"title",rules:[{required:!0,message:"试炼标题不能为空",trigger:"blur"}]},{default:a(()=>[l(u,{modelValue:e.value.title,"onUpdate:modelValue":t[0]||(t[0]=o=>e.value.title=o),placeholder:"请输入试炼标题",size:"large"},null,8,["modelValue"])]),_:1}),l(s,{label:"试炼简介",prop:"summary",rules:[{required:!0,message:"试炼简介不能为空",trigger:"blur"}]},{default:a(()=>[l(u,{modelValue:e.value.summary,"onUpdate:modelValue":t[1]||(t[1]=o=>e.value.summary=o),type:"textarea",rows:3,placeholder:"请输入试炼简介（将显示在试炼列表）","show-word-limit":"",maxlength:"500"},null,8,["modelValue"])]),_:1}),l(T,{gutter:24},{default:a(()=>[l(v,{span:8},{default:a(()=>[l(s,{label:"开始日期",prop:"startTime",rules:[{required:!0,message:"请选择开始日期",trigger:"change"}]},{default:a(()=>[l(n,{modelValue:e.value.startTime,"onUpdate:modelValue":t[2]||(t[2]=o=>e.value.startTime=o),type:"date","value-format":"YYYY-MM-DD",placeholder:"请选择开始日期",style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1}),l(v,{span:8},{default:a(()=>[l(s,{label:"截止日期",prop:"deadline",rules:[{required:!0,message:"请选择截止日期",trigger:"change"}]},{default:a(()=>[l(n,{modelValue:e.value.deadline,"onUpdate:modelValue":t[3]||(t[3]=o=>e.value.deadline=o),type:"date","value-format":"YYYY-MM-DD",placeholder:"请选择截止日期",style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1}),l(v,{span:8},{default:a(()=>[l(s,{label:"部落人数限制",prop:"maxMembers",rules:[{required:!0,message:"请输入人数限制",trigger:"change"}]},{default:a(()=>[l(M,{modelValue:e.value.maxMembers,"onUpdate:modelValue":t[4]||(t[4]=o=>e.value.maxMembers=o),min:1,style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),r("div",B,[t[7]||(t[7]=r("h3",{class:"section-title"},"试炼内容",-1)),t[8]||(t[8]=r("p",{class:"section-desc"},"使用 Markdown 语法编写试炼详情，支持标题、列表、代码、图片等",-1)),r("div",A,[l(C(I),{modelValue:e.value.content,"onUpdate:modelValue":t[5]||(t[5]=o=>e.value.content=o),theme:S,"preview-theme":F,"code-theme":O,toolbars:w,onOnUploadImg:V,placeholder:"请输入试炼详细内容..."},null,8,["modelValue"])])]),r("div",L,[l(_,{onClick:g,size:"large"},{default:a(()=>[...t[9]||(t[9]=[b("重置",-1)])]),_:1}),l(_,{type:"primary",onClick:x,loading:c.value,size:"large"},{default:a(()=>[b(E(c.value?"发布中...":"立即发布"),1)]),_:1},8,["loading"])])]),_:1},8,["model"])])}}},Q=U(j,[["__scopeId","data-v-2664520c"]]);export{Q as default};
