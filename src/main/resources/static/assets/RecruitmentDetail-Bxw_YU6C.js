const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/competition-DDRzTI-D.js","assets/index-LBqe1eNs.js","assets/index-Dc8zltW3.css"])))=>i.map(i=>d[i]);
import{y as R,a1 as ge,_ as ye,z as _e,r as h,c as E,o as he,D as we,V as O,a2 as be,d as y,e as m,f as l,m as I,w as u,q as V,u as Me,g as k,F as U,l as o,A as b,t as v,i as f,v as Y,k as ke,a3 as xe,a4 as Se,a5 as Ie,B as Ve,$ as De,a0 as Re,E as w,x as Ne}from"./index-LBqe1eNs.js";import{useRecruitmentStore as Ce}from"./recruitment-BogGKxph.js";import{useCompetitionStore as Te}from"./competition-BeX1I71u.js";import{u as Ae,g as Z}from"./team-DUt-q28F.js";import"./competition-DDRzTI-D.js";function Ee(n){return R.post("/chat/message/recruitment",n)}function Pe(n){return R.get("/chat/message/recruitment/list",{params:{recruitmentId:n}})}function te(n){return R.post("/chat/session/create",n)}function se(n={}){return R.get("/chat/session/list",{params:n})}function ae(n){return R.get("/chat/session/detail",{params:{sessionId:n}})}function le(n){return R.post("/chat/message/send",n)}function ne(n){return R.post("/chat/message/list",n)}const ee=Object.freeze(Object.defineProperty({__proto__:null,createChatSession:te,getChatSessionDetail:ae,listMessages:ne,listMySessions:se,listRecruitmentMessages:Pe,sendMessage:le,sendRecruitmentMessage:Ee},Symbol.toStringTag,{value:"Module"})),Be=ge("chat",{state:()=>({sessions:[],currentSession:null,messages:[],messagesByPost:{},loading:!1,error:null}),getters:{getSessionWithUser:n=>(s,d)=>n.sessions.find(D=>D.user1Id===d&&D.user2Id===s||D.user1Id===s&&D.user2Id===d)},actions:{async createSession(n){try{const s=await te(n),d=s?.data?.data;return d&&this.sessions.unshift(d),s}catch(s){throw console.error("createSession error",s),s}},async fetchSessions(n={}){this.loading=!0;try{const d=(await se(n))?.data?.data;return Array.isArray(d)?this.sessions=d:d?.list&&(this.sessions=d.list),this.sessions}catch(s){return console.error("fetchSessions error",s),[]}finally{this.loading=!1}},async fetchSessionDetail(n){this.loading=!0;try{const s=await ae(n),d=s?.data?.data||s?.data;return this.currentSession=d,d}catch(s){return console.error("fetchSessionDetail error",s),null}finally{this.loading=!1}},async sendMessage(n){this.error=null;try{const s=await le(n),d=s?.data?.data;return d&&this.messages.push(d),s}catch(s){throw console.error("sendMessage error",s),this.error=s?.message||"发送消息失败",s}},async fetchMessages(n){this.loading=!0,this.error=null;try{const d=(await ne(n))?.data?.data;return Array.isArray(d)?this.messages=d:d?.list&&(this.messages=d.list),this.messages}catch(s){return console.error("fetchMessages error",s),this.error=s?.message||"获取消息失败",[]}finally{this.loading=!1}},clearMessages(){this.messages=[]},addMessage(n,s){this.messagesByPost[n]||(this.messagesByPost[n]=[]),this.messagesByPost[n].push({...s,id:s.id||Date.now(),timestamp:s.timestamp||new Date().toISOString()})}}}),Oe={class:"page"},Ue={key:0,class:"loading-tip"},$e={class:"detail-card"},ze={class:"detail-header"},Le={class:"header-tags"},je={class:"detail-meta"},Fe={key:0},qe={key:1},He={key:0,class:"team-status-card"},Ke={class:"status-row"},We={class:"status-item"},Ge={class:"value"},Je={class:"status-item"},Qe={class:"value"},Xe={class:"status-item"},Ye={style:{display:"flex","justify-content":"space-between","align-items":"center"}},Ze={class:"detail-content"},et={key:1,class:"detail-tags"},tt={key:2,class:"detail-actions"},st={key:0,class:"contact-section"},at={key:1,class:"contact-section"},lt={class:"chat-section"},nt={class:"message-list"},ot={class:"message-header"},rt={class:"sender"},it={class:"time"},ut={class:"message-content"},dt={class:"message-input"},ct={__name:"RecruitmentDetail",setup(n){const s=we(),d=Me(),D=Ae(),$=Ce();Be();const x=_e(),oe=Te(),z=h(!1),L=h(!1),j=h(!1),F=h(!1),A=h(!1),P=h(!1),a=h(null),i=h(null),H=h(""),N=h(""),S=h([]);h(null);const M=h({title:"",content:"",maxMembers:2}),K=E(()=>i.value?i.value.currentNum||0||(i.value.members?.length||0)+1:0),W=E(()=>i.value?K.value>=(i.value.maxNum||a.value?.maxMembers||5):!1),C=E(()=>{if(!a.value)return!1;const t=a.value.authorId||a.value.userId;return String(t)===String(x.id)||a.value.author===x.userName}),re=E(()=>x.role==="admin"||x.userRoleNum===1),G=E(()=>!i.value||!x.id?!1:i.value.leaderId===x.id?!0:(i.value.members||[]).some(t=>t.userId===x.id));he(async()=>{const t=Number(s.params.id);if(t){z.value=!0;try{const e=await $.fetchDetail(t);a.value=e;try{const{listRecruitmentMessages:r}=await O(async()=>{const{listRecruitmentMessages:p}=await Promise.resolve().then(()=>ee);return{listRecruitmentMessages:p}},void 0),g=(await r(t))?.data?.data||[];S.value=g.map(p=>({id:p.id,sender:p.senderName||p.senderId,text:p.content,timestamp:p.createTime||p.createdAt}))}catch(r){console.warn("加载留言失败",r.message),S.value=[]}if(e){if(!e.competitionName&&e.competitionId)try{const r=await oe.fetchCompetition(e.competitionId);r&&(a.value={...a.value,competitionName:r.name})}catch(r){console.warn(`竞赛信息不存在或已删除 (ID: ${e.competitionId})`,r.message)}M.value={title:e.title,content:e.content,maxMembers:e.maxMembers||2};try{if(e.teamId){const r=await Z(e.teamId);i.value=r.data?.data}if(i.value){const{listCompetitionRegistrations:r}=await O(async()=>{const{listCompetitionRegistrations:p}=await import("./competition-DDRzTI-D.js");return{listCompetitionRegistrations:p}},__vite__mapDeps([0,1,2])),g=(await r(e.competitionId))?.data?.data||[];P.value=g.some(p=>p.teamId===i.value.id)}}catch(r){console.error("获取队伍信息失败",r)}J()}}finally{z.value=!1}}}),be(()=>{});function J(){setTimeout(()=>{const t=document.querySelector(".message-list");t&&(t.scrollTop=t.scrollHeight)},100)}function Q(t){if(!t)return"";const e=new Date(t);return`${e.getMonth()+1}/${e.getDate()} ${e.getHours()}:${String(e.getMinutes()).padStart(2,"0")}`}async function ie(){if(!i.value.team.id){w.error("队伍信息不存在");return}const t=i.value.team.id;if(!t||t<=0){w.error("无效的队伍ID，无法加入");return}L.value=!0;try{await D.joinTeam(t),w.success("加入成功！你已成为该部落的一员。"),i.value=D.currentTeam||await Z(t)}catch(e){const r=e.response?.data?.message||e.message||"加入失败，请重试";w.error(r)}finally{L.value=!1}}async function X(){if(!N.value.trim())return;const t=N.value;N.value="";const e={id:Date.now(),sender:x.userName||"我",text:t,timestamp:new Date().toISOString()};S.value.push(e),J();try{const{sendRecruitmentMessage:r}=await O(async()=>{const{sendRecruitmentMessage:p}=await Promise.resolve().then(()=>ee);return{sendRecruitmentMessage:p}},void 0),g=(await r({recruitmentId:a.value.id,content:t}))?.data?.data;if(g){const p=S.value.findIndex(T=>T.id===e.id);p!==-1&&(S.value[p]={id:g.id,sender:g.senderName||g.senderId,text:g.content,timestamp:g.createTime||g.createdAt})}}catch(r){w.error("发送失败："+(r.message||"网络错误")),S.value=S.value.filter(_=>_.id!==e.id)}}function ue(){M.value={title:a.value.title,content:a.value.content,maxMembers:a.value.maxMembers||2},A.value=!0}async function de(){j.value=!0;try{await $.update(a.value.id,M.value),a.value={...a.value,...M.value},w.success("更新成功"),A.value=!1}catch{w.error("更新失败")}finally{j.value=!1}}async function ce(){try{await Ne.confirm("确定删除这个招募帖吗？","删除确认",{type:"warning"}),console.log("Deleting recruitment:",a.value.id),await $.delete(a.value.id),w.success("删除成功"),d.push("/recruitments")}catch(t){t!=="cancel"&&(console.error("Delete failed:",t),w.error("删除失败: "+(t.message||"未知错误")))}}async function me(){if(!(!i.value||!a.value)){F.value=!0;try{const{registerCompetition:t}=await O(async()=>{const{registerCompetition:r}=await import("./competition-DDRzTI-D.js");return{registerCompetition:r}},__vite__mapDeps([0,1,2])),e=await t({competitionId:a.value.competitionId,teamId:i.value.id});e?.data?.code===0?(w.success("报名成功！部落已提交试炼申请，请等待萨满哥布林审核"),P.value=!0,w.info("您可以在竞赛详情页刷新查看审核状态",{duration:5e3})):w.error(e?.data?.message||"报名失败")}catch(t){console.error("autoRegister error",t),w.error("报名失败："+(t.response?.data?.message||t.message))}finally{F.value=!1}}}return(t,e)=>{const r=k("el-icon"),_=k("el-button"),g=k("el-empty"),p=k("el-tag"),T=k("el-alert"),B=k("el-input"),q=k("el-form-item"),pe=k("el-input-number"),ve=k("el-form"),fe=k("el-dialog");return m(),y("div",Oe,[l(_,{onClick:e[0]||(e[0]=c=>V(d).back()),type:"text",class:"back-btn"},{default:u(()=>[l(r,null,{default:u(()=>[l(V(xe))]),_:1}),e[8]||(e[8]=f(" 返回列表 ",-1))]),_:1}),z.value?(m(),y("div",Ue,"加载中...")):a.value?(m(),y(U,{key:2},[o("div",$e,[o("div",ze,[o("h1",null,v(a.value.title),1),o("div",Le,[a.value.competitionName?(m(),I(p,{key:0,type:"primary",effect:"dark"},{default:u(()=>[l(r,null,{default:u(()=>[l(V(Se))]),_:1}),f(" "+v(a.value.competitionName),1)]),_:1})):b("",!0),i.value?(m(),I(p,{key:1,type:"success",effect:"plain"},{default:u(()=>[l(r,null,{default:u(()=>[l(V(Ie))]),_:1}),f(" "+v(i.value.name),1)]),_:1})):b("",!0)])]),o("div",je,[o("span",null,[l(r,null,{default:u(()=>[l(V(Ve))]),_:1}),f(" 发布哥布林："+v(a.value.authorName||(i.value?i.value.leaderName:null)||a.value.author||a.value.userId),1)]),a.value.createdAt?(m(),y("span",Fe,[l(r,null,{default:u(()=>[l(V(De))]),_:1}),f(" 发布于："+v(Q(a.value.createdAt)),1)])):b("",!0),a.value.maxMembers?(m(),y("span",qe,[l(r,null,{default:u(()=>[l(V(Re))]),_:1}),f(" 招募需求："+v(a.value.maxMembers)+" 只",1)])):b("",!0)]),i.value?(m(),y("div",He,[e[14]||(e[14]=o("h4",null,"部落当前状况",-1)),o("div",Ke,[o("div",We,[e[9]||(e[9]=o("span",{class:"label"},"当前哥布林数：",-1)),o("span",Ge,v(K.value)+" / "+v(i.value.maxNum),1)]),o("div",Je,[e[10]||(e[10]=o("span",{class:"label"},"酋长：",-1)),o("span",Qe,v(i.value.leaderName||i.value.leaderId),1)]),o("div",Xe,[e[11]||(e[11]=o("span",{class:"label"},"状态：",-1)),l(p,{size:"small",type:i.value.status===1?"danger":"success"},{default:u(()=>[f(v(i.value.status===1?"已满员":"招募中"),1)]),_:1},8,["type"])])]),W.value&&!P.value&&C.value?(m(),I(T,{key:0,title:"部落人员已齐全！",type:"success",closable:!1,"show-icon":"",style:{"margin-top":"16px"}},{default:u(()=>[o("div",Ye,[e[13]||(e[13]=o("span",null,"人员已满，点击下方按钮自动报名该试炼",-1)),l(_,{type:"primary",size:"small",onClick:me,loading:F.value},{default:u(()=>[...e[12]||(e[12]=[f(" 立即报名 ",-1)])]),_:1},8,["loading"])])]),_:1})):W.value&&P.value&&C.value?(m(),I(T,{key:1,title:"部落已报名！",type:"info",closable:!1,"show-icon":"",style:{"margin-top":"16px"}})):b("",!0)])):b("",!0),o("div",Ze,[e[15]||(e[15]=o("h3",null,"详情描述",-1)),o("p",null,v(a.value.content),1)]),a.value.tags?.length?(m(),y("div",et,[(m(!0),y(U,null,Y(a.value.tags,c=>(m(),I(p,{key:c,size:"small",type:"info"},{default:u(()=>[f(v(c),1)]),_:2},1024))),128))])):b("",!0),C.value||re.value?(m(),y("div",tt,[C.value?(m(),I(_,{key:0,type:"primary",onClick:ue},{default:u(()=>[...e[16]||(e[16]=[f("编辑招募令",-1)])]),_:1})):b("",!0),l(_,{type:"danger",onClick:ce},{default:u(()=>[...e[17]||(e[17]=[f("删除招募令",-1)])]),_:1})])):b("",!0)]),!C.value&&!G.value&&V(x).role!=="admin"?(m(),y("div",st,[e[19]||(e[19]=o("h3",null,"申请加入",-1)),i.value&&i.value.status===1?(m(),I(T,{key:0,title:"该部落已满员，无法申请",type:"warning",closable:!1,"show-icon":""})):(m(),y(U,{key:1},[l(B,{modelValue:H.value,"onUpdate:modelValue":e[1]||(e[1]=c=>H.value=c),type:"textarea",rows:3,placeholder:"简单介绍自己，说明你的优势和时间安排..."},null,8,["modelValue"]),l(_,{type:"primary",onClick:ie,loading:L.value,style:{"margin-top":"12px"}},{default:u(()=>[...e[18]||(e[18]=[f(" 加入部落 ",-1)])]),_:1},8,["loading"])],64))])):b("",!0),G.value&&!C.value?(m(),y("div",at,[l(T,{title:"你已经是该部落的部下",type:"success",closable:!1,"show-icon":""})])):b("",!0),o("div",lt,[e[21]||(e[21]=o("h3",null,"留言交流",-1)),o("div",nt,[(m(!0),y(U,null,Y(S.value,c=>(m(),y("div",{key:c.id,class:"message-item"},[o("div",ot,[o("span",rt,v(c.sender||c.senderName),1),o("span",it,v(Q(c.timestamp||c.createdAt)),1)]),o("div",ut,v(c.text||c.content),1)]))),128)),S.value.length===0?(m(),I(g,{key:0,description:"暂无留言","image-size":60})):b("",!0)]),o("div",dt,[l(B,{modelValue:N.value,"onUpdate:modelValue":e[2]||(e[2]=c=>N.value=c),placeholder:"输入留言...",onKeyup:ke(X,["enter"])},null,8,["modelValue"]),l(_,{type:"primary",onClick:X,disabled:!N.value.trim()},{default:u(()=>[...e[20]||(e[20]=[f("发送",-1)])]),_:1},8,["disabled"])])])],64)):(m(),I(g,{key:1,description:"招募令不存在"})),l(fe,{modelValue:A.value,"onUpdate:modelValue":e[7]||(e[7]=c=>A.value=c),title:"编辑招募令",width:"600px"},{footer:u(()=>[l(_,{onClick:e[6]||(e[6]=c=>A.value=!1)},{default:u(()=>[...e[22]||(e[22]=[f("取消",-1)])]),_:1}),l(_,{type:"primary",onClick:de,loading:j.value},{default:u(()=>[...e[23]||(e[23]=[f("保存",-1)])]),_:1},8,["loading"])]),default:u(()=>[l(ve,{model:M.value,"label-width":"100px"},{default:u(()=>[l(q,{label:"标题"},{default:u(()=>[l(B,{modelValue:M.value.title,"onUpdate:modelValue":e[3]||(e[3]=c=>M.value.title=c)},null,8,["modelValue"])]),_:1}),l(q,{label:"招募需求"},{default:u(()=>[l(pe,{modelValue:M.value.maxMembers,"onUpdate:modelValue":e[4]||(e[4]=c=>M.value.maxMembers=c),min:1,max:10},null,8,["modelValue"])]),_:1}),l(q,{label:"详细法则"},{default:u(()=>[l(B,{modelValue:M.value.content,"onUpdate:modelValue":e[5]||(e[5]=c=>M.value.content=c),type:"textarea",rows:4},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},yt=ye(ct,[["__scopeId","data-v-de4fe56b"]]);export{yt as default};
