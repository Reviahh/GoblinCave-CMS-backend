import{_ as te,r as c,a as oe,c as h,o as ne,b as q,E as n,d as ue,e as M,f as a,w as r,g as u,h as ie,i as m,j as de,k as me,l as P,m as pe,t as ge,n as ce,p as T}from"./index-LBqe1eNs.js";const fe={class:"users-management"},ve={class:"dialog-footer"},we={class:"dialog-footer"},_e={__name:"Users",setup(be){const U=c(!1),p=c([]),i=oe({username:"",pageNum:1,pageSize:5}),V=c(!1),N=c(""),b=c(null),o=c({id:null,userAccount:"",email:"",phone:"",tags:"",userRole:0}),R=c(!1),A=c(null),g=c({id:null,newPassword:"",confirmPassword:""}),D={newPassword:[{required:!0,message:"请输入新密码",trigger:"blur"},{min:8,message:"密码至少 8 位",trigger:["blur","change"]}],confirmPassword:[{required:!0,message:"请确认新密码",trigger:"blur"},{validator:(l,e,t)=>{e!==g.value.newPassword?t(new Error("两次输入密码不一致")):t()},trigger:["blur","change"]}]},$={userAccount:[{required:!0,message:"请输入哥布林名",trigger:"blur"},{min:1,max:50,message:"哥布林名长度应在1到50个字符之间",trigger:["blur","change"]},{validator:(l,e,t)=>{!e||e.trim()===""?t(new Error("哥布林名不能为空或仅包含空格")):t()},trigger:["blur","change"]}],email:[{required:!0,message:"请输入邮箱",trigger:"blur"},{type:"email",message:"请输入正确的邮箱地址",trigger:["blur","change"]},{validator:(l,e,t)=>{!e||e.trim()===""?t(new Error("邮箱不能为空或仅包含空格")):/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)?t():t(new Error("邮箱格式不正确"))},trigger:["blur","change"]}],phone:[{required:!1},{validator:(l,e,t)=>{if(!e)return t();/^1[3-9]\d{9}$/.test(e)?t():t(new Error("请输入正确的手机号"))},trigger:["blur","change"]}],tags:[{required:!1},{max:512,message:"签名最多 512 个字符",trigger:["blur","change"]}],userRole:[{required:!0,message:"请选择角色",trigger:["change","blur"]},{validator:(l,e,t)=>{e!==0&&e!==1?t(new Error("角色值必须为0（求学哥布林）或1（管理哥布林）")):t()},trigger:["change","blur"]}]};let f=null;const L=h(()=>{const l=(i.pageNum-1)*i.pageSize,e=l+i.pageSize;return p.value.slice(l,e)}),B=h(()=>p.value.length);ne(()=>{y()});const y=async()=>{U.value=!0;try{const l=await q({userName:i.username});if(l?.code===0){if(!l.data){p.value=[],n.warning("未返回哥布林数据");return}if(!Array.isArray(l.data)){p.value=[],n.error("返回的哥布林数据格式错误");return}if(p.value=l.data,Array.isArray(l.data)&&l.data.length===0&&i.username){console.debug("userSearch: no results by userName, trying fallback by userAccount");try{const e=await q({userName:""}),t=e?.code===0&&Array.isArray(e.data)?e.data:[],C=String(i.username).toLowerCase();p.value=t.filter(d=>d.userAccount&&String(d.userAccount).toLowerCase().includes(C)||d.userName&&String(d.userName).toLowerCase().includes(C))}catch(e){console.debug("userSearch: fallback failed",e)}}p.value.length===0&&i.username}else{const e=l?.message||"获取哥布林名册失败，请稍后重试";n.error(e),p.value=[]}}catch(l){const e=l?.response?.data?.message||l?.message||"网络错误，无法获取哥布林名册";n.error(e),p.value=[]}finally{U.value=!1}},I=()=>{f&&clearTimeout(f),f=setTimeout(()=>{i.pageNum=1,y()},300)},S=()=>{f&&(clearTimeout(f),f=null),i.pageNum=1,y()},j=()=>{f&&clearTimeout(f),i.pageNum=1,y()},K=l=>{o.value={id:l.id,userAccount:l.userAccount||l.userName,email:l.email,phone:l.phone,tags:l.tags,userRole:l.userRole??0},N.value="编辑哥布林",V.value=!0},G=l=>{g.value={id:l.id,newPassword:"",confirmPassword:""},R.value=!0},H=async()=>{if(!A.value){n.error("表单未初始化");return}try{if(!await A.value.validate())return}catch{n.warning("请检查重置密码表单");return}try{const l={id:g.value.id,userPassword:g.value.newPassword},e=await T(l);e?.code===0?(n.success("密码已重置"),R.value=!1):n.error(e?.message||"重置密码失败")}catch(l){const e=l?.response?.data?.message||l?.message||"网络错误，无法重置密码";n.error(e)}},J=async l=>{try{const e=await ce(l);if(e?.code===0)n.success("驱逐成功！"),y();else{const t=e?.message||"驱逐哥布林失败，请稍后重试";n.error(t)}}catch(e){const t=e?.response?.data?.message||e?.message||"网络错误，无法驱逐哥布林";n.error(t)}},O=async()=>{if(!b.value){n.error("表单未初始化");return}try{if(!await b.value.validate()){n.warning("请填写完整的表单信息");return}}catch{n.warning("请检查表单中的错误信息");return}try{const l={id:o.value.id,userAccount:o.value.userAccount,email:o.value.email,phone:o.value.phone,tags:o.value.tags,userRole:o.value.userRole},e=await T(l);if(e?.code===0)n.success("更新成功！"),V.value=!1,y();else{const t=e?.message||"更新哥布林信息失败，请稍后重试";n.error(t)}}catch(l){const e=l?.response?.data?.message||l?.message||"网络错误，无法更新哥布林信息";n.error(e)}},Q=()=>{o.value={id:null,userAccount:"",email:"",userRole:0},b.value&&(b.value.clearValidate(),b.value.resetFields())};return(l,e)=>{const t=u("el-breadcrumb-item"),C=u("el-breadcrumb"),d=u("el-button"),w=u("el-input"),x=u("el-col"),W=u("el-row"),v=u("el-table-column"),X=u("el-tag"),Y=u("el-popconfirm"),Z=u("el-space"),ee=u("el-table"),ae=u("el-pagination"),le=u("el-card"),_=u("el-form-item"),z=u("el-option"),re=u("el-select"),k=u("el-form"),E=u("el-dialog"),se=ie("loading");return M(),ue("div",fe,[a(C,{separator:"/"},{default:r(()=>[a(t,{to:{path:"/admin"}},{default:r(()=>[...e[15]||(e[15]=[m("统治者后台",-1)])]),_:1}),a(t,null,{default:r(()=>[...e[16]||(e[16]=[m("哥布林名册",-1)])]),_:1})]),_:1}),a(le,{class:"box-card"},{default:r(()=>[a(W,{gutter:20},{default:r(()=>[a(x,{span:8},{default:r(()=>[a(w,{placeholder:"请输入哥布林代号进行搜索",modelValue:i.username,"onUpdate:modelValue":e[0]||(e[0]=s=>i.username=s),clearable:"",onClear:j,onInput:I,onKeydown:me(S,["enter","native"])},{append:r(()=>[a(d,{onClick:S,size:"small"},{default:r(()=>[...e[17]||(e[17]=[P("i",{class:"el-icon-search"},null,-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),a(x,{span:4})]),_:1}),de((M(),pe(ee,{data:L.value,border:"",stripe:""},{default:r(()=>[a(v,{type:"index",label:"#"}),a(v,{label:"哥布林代号",prop:"userAccount"}),a(v,{label:"邮箱",prop:"email"}),a(v,{label:"电话",prop:"phone"}),a(v,{label:"签名",prop:"tags"}),a(v,{label:"身份",prop:"userRole"},{default:r(s=>[a(X,{type:s.row.userRole===1?"success":"info"},{default:r(()=>[m(ge(s.row.userRole===1?"管理哥布林":"求学哥布林"),1)]),_:2},1032,["type"])]),_:1}),a(v,{label:"入洞时间",prop:"createTime"}),a(v,{label:"操作",width:"220px"},{default:r(s=>[a(Z,{align:"center",size:"small"},{default:r(()=>[a(d,{type:"primary",size:"small",onClick:F=>K(s.row)},{default:r(()=>[...e[18]||(e[18]=[m("编辑",-1)])]),_:1},8,["onClick"]),a(d,{type:"warning",size:"small",onClick:F=>G(s.row)},{default:r(()=>[...e[19]||(e[19]=[m("重置口令",-1)])]),_:1},8,["onClick"]),a(Y,{title:"确定要驱逐这个哥布林吗?",onConfirm:F=>J(s.row.id)},{reference:r(()=>[a(d,{type:"danger",size:"small"},{default:r(()=>[...e[20]||(e[20]=[m("驱逐",-1)])]),_:1})]),_:1},8,["onConfirm"])]),_:2},1024)]),_:1})]),_:1},8,["data"])),[[se,U.value]]),a(ae,{"current-page":i.pageNum,"onUpdate:currentPage":e[1]||(e[1]=s=>i.pageNum=s),"page-size":i.pageSize,"onUpdate:pageSize":e[2]||(e[2]=s=>i.pageSize=s),"page-sizes":[5,10,20,50],layout:"total, sizes, prev, pager, next, jumper",total:B.value},null,8,["current-page","page-size","total"])]),_:1}),a(E,{modelValue:V.value,"onUpdate:modelValue":e[9]||(e[9]=s=>V.value=s),title:N.value,width:"50%",onClose:Q},{footer:r(()=>[P("span",ve,[a(d,{onClick:e[8]||(e[8]=s=>V.value=!1)},{default:r(()=>[...e[21]||(e[21]=[m("取消",-1)])]),_:1}),a(d,{type:"primary",onClick:O},{default:r(()=>[...e[22]||(e[22]=[m("确定",-1)])]),_:1})])]),default:r(()=>[a(k,{ref_key:"userFormRef",ref:b,model:o.value,rules:$,"label-width":"80px"},{default:r(()=>[a(_,{label:"代号",prop:"userAccount"},{default:r(()=>[a(w,{modelValue:o.value.userAccount,"onUpdate:modelValue":e[3]||(e[3]=s=>o.value.userAccount=s)},null,8,["modelValue"])]),_:1}),a(_,{label:"邮箱",prop:"email"},{default:r(()=>[a(w,{modelValue:o.value.email,"onUpdate:modelValue":e[4]||(e[4]=s=>o.value.email=s)},null,8,["modelValue"])]),_:1}),a(_,{label:"电话",prop:"phone"},{default:r(()=>[a(w,{modelValue:o.value.phone,"onUpdate:modelValue":e[5]||(e[5]=s=>o.value.phone=s)},null,8,["modelValue"])]),_:1}),a(_,{label:"签名",prop:"tags"},{default:r(()=>[a(w,{type:"textarea",rows:3,modelValue:o.value.tags,"onUpdate:modelValue":e[6]||(e[6]=s=>o.value.tags=s)},null,8,["modelValue"])]),_:1}),a(_,{label:"身份",prop:"userRole"},{default:r(()=>[a(re,{modelValue:o.value.userRole,"onUpdate:modelValue":e[7]||(e[7]=s=>o.value.userRole=s),placeholder:"请选择身份"},{default:r(()=>[a(z,{label:"求学哥布林",value:0}),a(z,{label:"管理哥布林",value:1})]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),a(E,{modelValue:R.value,"onUpdate:modelValue":e[13]||(e[13]=s=>R.value=s),title:"重置口令",width:"400px",onClose:e[14]||(e[14]=()=>{A.value.value&&A.value.value.clearValidate()})},{footer:r(()=>[P("span",we,[a(d,{onClick:e[12]||(e[12]=s=>R.value=!1)},{default:r(()=>[...e[23]||(e[23]=[m("取消",-1)])]),_:1}),a(d,{type:"primary",onClick:H},{default:r(()=>[...e[24]||(e[24]=[m("确定",-1)])]),_:1})])]),default:r(()=>[a(k,{ref_key:"resetFormRef",ref:A,model:g.value,rules:D,"label-width":"100px"},{default:r(()=>[a(_,{label:"新口令",prop:"newPassword"},{default:r(()=>[a(w,{modelValue:g.value.newPassword,"onUpdate:modelValue":e[10]||(e[10]=s=>g.value.newPassword=s),type:"password",autocomplete:"new-password"},null,8,["modelValue"])]),_:1}),a(_,{label:"确认口令",prop:"confirmPassword"},{default:r(()=>[a(w,{modelValue:g.value.confirmPassword,"onUpdate:modelValue":e[11]||(e[11]=s=>g.value.confirmPassword=s),type:"password",autocomplete:"new-password"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},Ve=te(_e,[["__scopeId","data-v-d29f1e8b"]]);export{Ve as default};
