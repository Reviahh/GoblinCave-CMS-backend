import{u as z}from"./submission-C873XoBW.js";import{useCompetitionStore as G}from"./competition-BeX1I71u.js";import{downloadSubmission as K}from"./submission-DCFVV_C6.js";import{_ as P,r as _,c as Q,o as W,d as v,e as i,l as M,m as p,f as o,w as l,g as u,A as S,F as X,v as Z,q as ee,i as a,t as d,E as w}from"./index-LBqe1eNs.js";import"./competition-DDRzTI-D.js";const te={class:"page"},le={class:"filter-bar"},oe={key:0,class:"loading-tip"},ae={key:1,class:"submission-list"},ne={key:1,style:{color:"#909399"}},se={key:1},ie={key:1},ue={__name:"AdminSubmissions",setup(re){const C=z(),L=G(),U=_(!1),D=_(!1),y=_(null),g=_(!1),N=_(!1),n=_(null),A=Q(()=>C.submissions),m=_({score:0,comment:""});W(async()=>{await L.fetchList()});async function I(){if(y.value){U.value=!0;try{await C.fetchList({competitionId:y.value})}finally{U.value=!1}}}function j(s){if(!s)return"";const e=new Date(s);return`${e.getFullYear()}-${e.getMonth()+1}-${e.getDate()} ${e.getHours()}:${String(e.getMinutes()).padStart(2,"0")}`}function R(s){n.value=s,N.value=!0}async function F(s){if(s.id)try{const k=(await K(s.id)).data;if(k.type.includes("application/json")){const r=await k.text(),$=JSON.parse(r);w.error($.message||"文件下载失败");return}let V="downloaded_file";if(s.fileUrl){const r=s.fileUrl.split("/");V=r[r.length-1]}const c=URL.createObjectURL(k),b=document.createElement("a");b.href=c,b.download=V,b.click(),URL.revokeObjectURL(c)}catch(e){console.error(e),w.error("下载失败")}}function O(s){n.value=s,m.value={score:s.score??0,comment:s.comment??""},g.value=!0}async function T(){if(m.value.score<0||m.value.score>100){w.warning("评分需在 0-100 之间");return}D.value=!0;try{await C.score({submissionId:n.value.id,score:m.value.score,comment:m.value.comment}),w.success("评分成功"),g.value=!1,await I()}catch(s){w.error("评分失败："+(s?.message||"未知错误"))}finally{D.value=!1}}return(s,e)=>{const k=u("el-option"),V=u("el-select"),c=u("el-table-column"),b=u("el-tag"),r=u("el-button"),$=u("el-table"),B=u("el-empty"),h=u("el-form-item"),q=u("el-input-number"),H=u("el-input"),J=u("el-form"),E=u("el-dialog"),f=u("el-descriptions-item"),Y=u("el-descriptions");return i(),v("div",te,[e[13]||(e[13]=M("h2",null,"战利品鉴定",-1)),M("div",le,[o(V,{modelValue:y.value,"onUpdate:modelValue":e[0]||(e[0]=t=>y.value=t),placeholder:"选择试炼",style:{width:"300px"},onChange:I},{default:l(()=>[(i(!0),v(X,null,Z(ee(L).competitions,t=>(i(),p(k,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),U.value?(i(),v("div",oe,"加载中...")):y.value?(i(),v("div",ae,[o($,{data:A.value,style:{width:"100%"}},{default:l(()=>[o(c,{prop:"id",label:"ID",width:"80"}),o(c,{prop:"teamName",label:"部落名称"}),o(c,{label:"部下","show-overflow-tooltip":""},{default:l(({row:t})=>[a(d(t.members?.map(x=>x.userName).join("、")||"-"),1)]),_:1}),o(c,{prop:"description",label:"战利品描述","show-overflow-tooltip":""}),o(c,{prop:"createdAt",label:"上交时间",width:"160"},{default:l(({row:t})=>[a(d(j(t.createdAt||t.submitTime)),1)]),_:1}),o(c,{prop:"score",label:"战力值",width:"100"},{default:l(({row:t})=>[t.score!=null?(i(),p(b,{key:0,type:"success"},{default:l(()=>[a(d(t.score),1)]),_:2},1024)):(i(),v("span",ne,"待鉴定"))]),_:1}),o(c,{label:"操作",width:"200"},{default:l(({row:t})=>[o(r,{type:"text",onClick:x=>R(t)},{default:l(()=>[...e[7]||(e[7]=[a("查看",-1)])]),_:1},8,["onClick"]),t.fileUrl?(i(),p(r,{key:0,type:"text",onClick:x=>F(t)},{default:l(()=>[...e[8]||(e[8]=[a("下载",-1)])]),_:1},8,["onClick"])):S("",!0),o(r,{type:"primary",text:"",onClick:x=>O(t)},{default:l(()=>[...e[9]||(e[9]=[a("鉴定",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"]),A.value.length===0?(i(),p(B,{key:0,description:"暂无上交战利品"})):S("",!0)])):(i(),p(B,{key:2,description:"请选择试炼"})),o(E,{modelValue:g.value,"onUpdate:modelValue":e[4]||(e[4]=t=>g.value=t),title:"鉴定",width:"500px"},{footer:l(()=>[o(r,{onClick:e[3]||(e[3]=t=>g.value=!1)},{default:l(()=>[...e[10]||(e[10]=[a("取消",-1)])]),_:1}),o(r,{type:"primary",onClick:T,loading:D.value},{default:l(()=>[...e[11]||(e[11]=[a("确认鉴定",-1)])]),_:1},8,["loading"])]),default:l(()=>[o(J,{model:m.value,"label-width":"80px"},{default:l(()=>[o(h,{label:"部落"},{default:l(()=>[a(d(n.value?.teamName),1)]),_:1}),o(h,{label:"战力值",required:""},{default:l(()=>[o(q,{modelValue:m.value.score,"onUpdate:modelValue":e[1]||(e[1]=t=>m.value.score=t),min:0,max:100,step:1,style:{width:"200px"}},null,8,["modelValue"])]),_:1}),o(h,{label:"萨满评语"},{default:l(()=>[o(H,{modelValue:m.value.comment,"onUpdate:modelValue":e[2]||(e[2]=t=>m.value.comment=t),type:"textarea",rows:4,placeholder:"输入萨满评语（可选）"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),o(E,{modelValue:N.value,"onUpdate:modelValue":e[6]||(e[6]=t=>N.value=t),title:"战利品详情",width:"600px"},{default:l(()=>[n.value?(i(),p(Y,{key:0,column:1,border:""},{default:l(()=>[o(f,{label:"战利品ID"},{default:l(()=>[a(d(n.value.id),1)]),_:1}),o(f,{label:"部落"},{default:l(()=>[a(d(n.value.teamName),1)]),_:1}),o(f,{label:"部下"},{default:l(()=>[a(d(n.value.members?.map(t=>t.userName).join("、")||"-"),1)]),_:1}),o(f,{label:"描述"},{default:l(()=>[a(d(n.value.description||"无"),1)]),_:1}),o(f,{label:"上交时间"},{default:l(()=>[a(d(j(n.value.createdAt)),1)]),_:1}),o(f,{label:"文件"},{default:l(()=>[n.value.fileUrl?(i(),p(r,{key:0,type:"primary",text:"",onClick:e[5]||(e[5]=t=>F(n.value))},{default:l(()=>[...e[12]||(e[12]=[a(" 下载战利品 ",-1)])]),_:1})):(i(),v("span",se,"无战利品"))]),_:1}),o(f,{label:"战力值"},{default:l(()=>[n.value.score!=null?(i(),p(b,{key:0,type:"success"},{default:l(()=>[a(d(n.value.score),1)]),_:1})):(i(),v("span",ie,"待评审"))]),_:1}),n.value.comment?(i(),p(f,{key:0,label:"评语"},{default:l(()=>[a(d(n.value.comment),1)]),_:1})):S("",!0)]),_:1})):S("",!0)]),_:1},8,["modelValue"])])}}},_e=P(ue,[["__scopeId","data-v-1d975eef"]]);export{_e as default};
