const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/recruitment-BogGKxph.js","assets/index-LBqe1eNs.js","assets/index-Dc8zltW3.css","assets/team-DUt-q28F.js"])))=>i.map(i=>d[i]);
import{a1 as h,V as c}from"./index-LBqe1eNs.js";import{deleteCompetition as p,getMyRegistration as u,listCompetitionRegistrations as l,getMyCompetitions as f,updateCompetition as y,createCompetition as g,getCompetition as C,listCompetitions as m,registerCompetition as R}from"./competition-DDRzTI-D.js";function a(t){return t?{id:t.id??t.competitionId??t.competition_id??null,name:t.name??t.title??"",summary:t.summary??t.description??t.desc??"",content:t.content??t.contentUrl??t.content_url??t.url??"",startTime:t.startTime??t.start_time??t.startAt??t.start??"",endTime:t.endTime??t.end_time??t.endAt??t.end??"",creatorId:t.creatorId??t.creator??t.userId??t.creator_id??"",maxMembers:t.maxMembers??t.max_members??t.capacity??0}:null}const I=h("competition",{state:()=>({competitions:[],registrations:{},myRegistration:{},loading:!1,error:null}),getters:{getById:t=>e=>t.competitions.find(i=>i.id==e),isLoading:t=>t.loading,hasError:t=>!!t.error},actions:{clearError(){this.error=null},async registerCompetition(t){try{return await R(t)}catch(e){throw console.error("registerCompetition error",e),e}},async fetchDetail(t){return this.fetchCompetition(t)},async fetchList(t={pageNum:1,pageSize:100}){this.loading=!0,this.error=null;try{const e=await m(t),i=e?.data?.data;let o=[];Array.isArray(i)?o=i:Array.isArray(i?.list)?o=i.list:Array.isArray(e?.data)&&(o=e.data);const r=o.map(n=>a(n)).filter(Boolean);return this.competitions=r,this.competitions}catch(e){return this.error=e?.message||"获取竞赛列表失败",this.competitions}finally{this.loading=!1}},async fetchCompetition(t){this.loading=!0,this.error=null;try{let e=null;try{const i=await C(t),o=i?.data?.data||i?.data;e=a(o)}catch(i){console.warn(`[Competition] getCompetition(${t}) failed:`,i.message)}if(!e){console.log(`[Competition] Trying fallback list for id=${t}`);try{const i=await m(),r=(i?.data?.data||i?.data||[]).find(n=>n.id==t);r&&(e=a(r),console.log("[Competition] Found in list fallback:",e.name))}catch(i){console.error("[Competition] List fallback failed:",i)}}if(e){const i=this.competitions.findIndex(o=>o.id==e.id);return i!==-1?this.competitions[i]=e:this.competitions.push(e),e}throw new Error("无法获取竞赛信息")}catch(e){return console.error("fetchCompetition error",e),this.error=e?.message||"获取竞赛详情失败",null}finally{this.loading=!1}},setCompetitions(t){Array.isArray(t)?this.competitions=t.map(a).filter(Boolean):this.competitions=[]},async addCompetition(t){this.loading=!0,this.error=null;try{const e=await g(t),i=e?.data?.data||e?.data;return typeof i=="number"?this.competitions.push({...t,id:i}):e?.data?.data?this.competitions.push(e.data.data):this.competitions.push(t),e}catch(e){throw console.error("addCompetition error",e),this.error=e?.message||"创建竞赛失败",e}finally{this.loading=!1}},addLocalCompetition(t){try{const e=a(t)||{...t,id:t.id??Date.now()};return e.id||(e.id=Date.now()),this.competitions.push(e),e}catch(e){throw console.error("addLocalCompetition error",e),e}},async updateCompetition(t,e){this.loading=!0,this.error=null;try{const i={id:t,...e},o=await y(i),r=this.competitions.findIndex(n=>n.id===t);return r!==-1&&(this.competitions[r]={...this.competitions[r],...e}),o}catch(i){throw console.error("updateCompetition error",i),this.error=i?.message||"更新竞赛失败",i}finally{this.loading=!1}},async fetchMyRegistrationStatus(t){try{return!!((await f())?.data?.data||[]).find(r=>r.id===t)}catch(e){return console.error("fetchMyRegistrationStatus error",e),!1}},async listCompetitionRegistrations(t){try{return(await l(t))?.data?.data||[]}catch(e){return console.error("listCompetitionRegistrations error",e),[]}},async fetchCompetitionRegistrations(t){this.loading=!0,this.error=null;try{const i=(await l(t))?.data?.data||[];return this.registrations[t]=i,i}catch(e){return this.error=e?.message||"获取报名列表失败",console.error("fetchCompetitionRegistrations error",e),[]}finally{this.loading=!1}},async fetchMyRegistration(t){this.loading=!0,this.error=null;try{const i=(await u(t))?.data?.data||null;return this.myRegistration[t]=i,i}catch(e){return this.error=e?.message||"获取我的报名记录失败",console.error("fetchMyRegistration error",e),null}finally{this.loading=!1}},async deleteCompetition(t){this.loading=!0,this.error=null;try{const e=await p(t);if(e?.data?.code===0||e?.code===0){this.competitions=this.competitions.filter(i=>i.id!==t);try{const{useRecruitmentStore:i}=await c(async()=>{const{useRecruitmentStore:s}=await import("./recruitment-BogGKxph.js");return{useRecruitmentStore:s}},__vite__mapDeps([0,1,2])),{useTeamStore:o}=await c(async()=>{const{useTeamStore:s}=await import("./team-DUt-q28F.js").then(d=>d.t);return{useTeamStore:s}},__vite__mapDeps([3,1,2])),r=i(),n=o();r.recruitments&&(r.recruitments=r.recruitments.filter(s=>s.competitionId!==t)),r.myRecruitments&&(r.myRecruitments=r.myRecruitments.filter(s=>s.competitionId!==t)),n.teams&&(n.teams=n.teams.filter(s=>s.competitionId!==t)),console.log(`[Competition] 已清理竞赛 ${t} 相关的前端缓存`),console.log("[Competition] 正在刷新数据..."),await Promise.all([this.fetchList(),r.fetchList().catch(s=>console.warn("刷新招募失败:",s)),n.fetchMyTeams().catch(s=>console.warn("刷新队伍失败:",s))]),console.log("[Competition] 数据刷新完成")}catch(i){console.warn("[Competition] 级联清理前端数据失败:",i);try{await this.fetchList()}catch(o){console.error("刷新竞赛列表失败:",o)}}return e}else throw new Error(e?.data?.message||e?.message||"删除失败")}catch(e){throw console.error("deleteCompetition error",e),this.error=e?.message||"删除竞赛失败",e}finally{this.loading=!1}}},persist:!0});export{I as useCompetitionStore};
